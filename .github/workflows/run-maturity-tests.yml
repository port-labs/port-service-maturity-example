name: Run service maturity tests

on:
  workflow_dispatch:

jobs:
  check-has-readme:
    uses: ./.github/workflows/check-has-readme.yml
    secrets: 
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}

  check-snyk-vulnerabilities-python:
    uses: ./.github/workflows/check-snyk-vulnerabilities-python.yml
    secrets: 
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  
  calculate-final-score:
    needs: [check-has-readme, check-snyk-vulnerabilities-python]
    runs-on: ubuntu-latest
    steps:
      - id: search-entities
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: SEARCH
          query:  |
            { "rules": [{ "operator": "=", "value": "Check", "property": "$blueprint"}], "combinator": "and" }
      - name: Get all checks and latest runs on the service
        run: |
          for check in ${{ search-entities.outputs.entities }}; do
            echo "$check"
          done