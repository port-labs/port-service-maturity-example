name: Run service maturity tests

on:
  workflow_dispatch:

jobs:
  check-has-readme:
    uses: ./.github/workflows/check-has-readme.yml
    secrets: 
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}

  check-snyk-vulnerabilities-python:
    uses: ./.github/workflows/check-snyk-vulnerabilities-python.yml
    secrets: 
      PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
      PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  
  calculate-final-score:
    needs: [check-has-readme, check-snyk-vulnerabilities-python]
    runs-on: ubuntu-latest
    steps:
      - id: search-checks
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: SEARCH
          query:  |
            {
               "combinator": "or",
               "rules": [{ "operator": "=", "value": "Check", "property": "$blueprint"}] 
            }
      - id: search-check-runs
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: SEARCH
          query:  |
            { 
              "combinator": "or",
              "rules": [
                { "operator": "=", "value": "CheckRuns", "property": "$blueprint"},
                { "operator": "relatedTo", "blueprint": "Service", "value": "payment-service" }
              ]
            }            
      - name: Get all checks and latest runs on the service
        run: |
          import os
          checks = sorted(${{ steps.search-checks.outputs.entities }}, key=lambda check: check["properties"]["tier"], reverse=True)
          final_rank = checks[0]["relations"]["rank"]
          for check in checks:
            currentCheckCheckRuns = [checkRun for checkRun in ${{ steps.search-check-runs.outputs.entities }} if checkRun["relations"]["check"] == check["identifier"]] 
            latestCheckRun = max(currentCheckCheckRuns, key=lambda checkRun: checkRun["createdAt"])
            if latestCheckRun["properties"]["status"] == "success": 
              final_rank = check["relations"]["rank"]
            else:
              break
          os.system("echo ::set-output name=final-rank::" + final_rank)
        shell: python

      - name: Update service maturity score
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          identifier: payment-service
          title: Payment Service
          blueprint: Service
          properties: |
            {
               "repo": "${{ github.event.repository.url }}"
            }
          relations: |
            {
              "rank": "${{ steps.calculate-final-score.outputs.final-rank }}"
            }